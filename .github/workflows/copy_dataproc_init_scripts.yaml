name: Copy Dataproc init scripts
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "dataproc/init_scripts/install_common.sh"
      - "dataproc/init_scripts/*.sh"
jobs:
  copy_init_scripts:
    runs-on: ubuntu-latest

    steps:
    - name: "checkout repo"
      uses: actions/checkout@v2

    - name: "gcloud setup"
      uses: google-github-actions/setup-gcloud@v0
      with:
        project_id: analysis-runner
        service_account_key: ${{ secrets.GCP_SERVER_DEPLOY_KEY }}

    - name: "copy scripts"
      run: |
        HAIL_VERSION=$(grep "DEFAULT_HAIL_VERSION = '" analysis_runner/dataproc.py | awk -F\' '{print $2}')
        gcloud storage cp "dataproc/init_scripts/*.sh" gs://cpg-common-main/hail_dataproc/${HAIL_VERSION}/
