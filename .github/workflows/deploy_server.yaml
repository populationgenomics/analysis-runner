name: Deploy analysis-runner server
on:
  workflow_dispatch:
    inputs:
      hail_ref:
        description: 'Hail repo ref (or commit SHA)'
        required: true
        default: "main"

permissions:
  contents: read
  id-token: write

jobs:
  deploy_server:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1
      BUILDKIT_PROGRESS: plain
      CLOUDSDK_CORE_DISABLE_PROMPTS: 1

    steps:
    - name: "checkout analysis-runner repo"
      uses: actions/checkout@v4

    - name: "checkout Hail repo"
      uses: actions/checkout@v4
      with:
        repository: "populationgenomics/hail"
        ref: ${{ github.event.inputs.hail_ref }}
        path: "hail"

    - name: "Determine Hail SHA"
      run: |
        cd hail
        echo "HAIL_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: "Set Docker image tag"
      run: |
        echo "IMAGE_TAG=${{ github.sha }}-hail-$HAIL_SHA" >> $GITHUB_ENV

#    - id: "google-cloud-auth"
#      name: "Authenticate to Google Cloud"
#      uses: google-github-actions/auth@v2
#      with:
#        workload_identity_provider: "projects/370374240567/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
#        service_account: "server-deploy@analysis-runner.iam.gserviceaccount.com"

    - id: "google-cloud-sdk-setup"
      name: "Set up Cloud SDK"
      uses: google-github-actions/setup-gcloud@v2

#    - name: "gcloud docker auth"
#      run: |
#        gcloud auth configure-docker marketplace.gcr.io,australia-southeast1-docker.pkg.dev

    - name: "build driver image"
      run: |
        docker build \
          -f driver/Dockerfile.hail \
          --build-arg HAIL_SHA=$HAIL_SHA \
          --tag banana \
          driver

    - name: "test driver image"
      run: |
        docker run banana python -c 'import hail; print(f"XXX Two: {hail.version()}")'
